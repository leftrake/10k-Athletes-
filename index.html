<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10k Athletes Challenge</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        input {
            padding: 10px;
            width: 300px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #info-section, #game-section, #username-setup-section {
            display: none;
        }
        #response {
            margin-top: 20px;
            font-weight: bold;
        }
        ul {
            text-align: left;
            display: inline-block;
            max-width: 400px;
        }
        h2 {
            color: #0056b3;
        }
        .guidelines {
            text-align: left;
            display: inline-block;
            margin: 10px auto;
            max-width: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .guidelines h3 {
            color: #007BFF;
        }
        .guidelines ul {
            padding-left: 20px;
        }
        .guidelines li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>10k Athletes Challenge</h1>

    <!-- Login Section -->
    <div id="login-section">
        <p>Log in with Google to start:</p>
        <button id="google-login-button">Log In with Google</button>
    </div>

    <!-- Username Setup Section -->
    <div id="username-setup-section">
        <h2>Set Up Your Username</h2>
        <p>Please enter a unique username to associate with your account:</p>
        <input type="text" id="username-input" placeholder="Enter your username" />
        <button id="save-username-button">Save Username</button>
    </div>

    <!-- Info Section -->
    <div id="info-section">
        <h2>Welcome to the 10k Athletes Challenge!</h2>
        <p><em>Prove you're the ultimate sports fan by naming as many athletes as you can!</em></p>
        <div class="guidelines">
            <h3>How to Play:</h3>
            <ul>
                <li>Think of a <strong>current professional athlete</strong>.</li>
                <li>Enter their name <strong>exactly</strong>, including punctuation and accents.</li>
                <li>Each correct name earns <strong>10 points</strong>, tracked on the leaderboard.</li>
                <li>Only <strong>current athletes</strong> are valid.</li>
            </ul>
        </div>
        <button id="start-game-button">Start Challenge</button>
        <button id="back-to-login-button">Back to Login</button>
    </div>

    <!-- Game Section -->
    <div id="game-section">
        <p>Enter a professional athlete's name below:</p>
        <input type="text" id="athlete-name" placeholder="Enter athlete name..." />
        <button id="submit-button">Submit</button>
        <button id="reset-button">Reset</button>
        <button id="back-to-info-button">Back to Info Page</button>
        <p id="response"></p>
        <h2>Your Score: <span id="score">0</span></h2>
        <h3>Named Athletes:</h3>
        <ul id="named-athletes"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBK6K_mqI83trEQxbdHDRCjLn0FB5DygrE",
            authDomain: "k-athletes-challenge.firebaseapp.com",
            databaseURL: "https://k-athletes-challenge-default-rtdb.firebaseio.com",
            projectId: "k-athletes-challenge",
            storageBucket: "k-athletes-challenge.appspot.com",
            messagingSenderId: "772472944883",
            appId: "1:772472944883:web:74a957e39b96d108745f86"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentPlayer = "";
        let score = 0;
        let namedAthletes = new Set();

        // Google Login
        document.getElementById("google-login-button").addEventListener("click", async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                currentPlayer = result.user.uid;

                const playerRef = ref(db, `players/${currentPlayer}`);
                const snapshot = await get(playerRef);

                if (!snapshot.exists()) {
                    // If no data exists, prompt the user to create a username
                    document.getElementById("login-section").style.display = "none";
                    document.getElementById("username-setup-section").style.display = "block";
                } else {
                    const data = snapshot.val();
                    if (!data.username) {
                        // If the user has no username, prompt to set one
                        document.getElementById("login-section").style.display = "none";
                        document.getElementById("username-setup-section").style.display = "block";
                    } else {
                        // User already has a username, proceed to info section
                        alert(`Welcome back, ${data.username}!`);
                        document.getElementById("login-section").style.display = "none";
                        document.getElementById("info-section").style.display = "block";
                    }
                }
            } catch (error) {
                console.error("Google login error:", error);
                alert("Google login failed.");
            }
        });

        // Save Username
        document.getElementById("save-username-button").addEventListener("click", async () => {
            const username = document.getElementById("username-input").value.trim();
            if (!username) {
                alert("Username cannot be empty.");
                return;
            }

            const usernamesRef = ref(db, "usernames");
            const snapshot = await get(usernamesRef);

            const usernames = snapshot.val() || {};

            if (Object.values(usernames).includes(username)) {
                alert("This username is already taken. Please choose another one.");
                return;
            }

            try {
                // Save the username
                await set(ref(db, `players/${currentPlayer}`), {
                    username,
                    score: 0,
                    namedAthletes: [],
                });

                // Keep a mapping of usernames to ensure uniqueness
                await set(ref(db, `usernames/${currentPlayer}`), username);

                alert("Username saved successfully!");
                document.getElementById("username-setup-section").style.display = "none";
                document.getElementById("info-section").style.display = "block";
            } catch (error) {
                console.error("Error saving username:", error);
                alert("Failed to save username.");
            }
        });

        // Start Game
        document.getElementById("start-game-button").addEventListener("click", () => {
            document.getElementById("info-section").style.display = "none";
            document.getElementById("game-section").style.display = "block";
        });

        // Back to Info
        document.getElementById("back-to-info-button").addEventListener("click", () => {
            document.getElementById("game-section").style.display = "none";
            document.getElementById("info-section").style.display = "block";
        });

        // Submit Athlete
        document.getElementById("submit-button").addEventListener("click", async () => {
            const athleteName = document.getElementById("athlete-name").value.trim();
            const responseElement = document.getElementById("response");

            if (athleteName === "") {
                responseElement.textContent = "Please enter a name!";
                responseElement.style.color = "red";
                return;
            }

            if (namedAthletes.has(athleteName.toLowerCase())) {
                responseElement.textContent = `${athleteName} already named!`;
                responseElement.style.color = "blue";
                return;
            }

            try {
                const response = await fetch(`https://www.thesportsdb.com/api/v1/json/3/searchplayers.php?p=${athleteName}`);
                const data = await response.json();

                if (data && data.player) {
                    const exactMatch = data.player.find(player => player.strPlayer.toLowerCase() === athleteName.toLowerCase());
                    if (exactMatch) {
                        namedAthletes.add(athleteName.toLowerCase());
                        score += 10;
                        document.getElementById("score").textContent = score;
                        addNamedAthleteToUI(exactMatch.strPlayer);

                        const playerRef = ref(db, `players/${currentPlayer}`);
                        await update(playerRef, { score, namedAthletes: Array.from(namedAthletes) });

                        responseElement.textContent = `${exactMatch.strPlayer} is valid!`;
                       
